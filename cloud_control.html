<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Smart Switch Cloud</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3680/3680321.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f8f9fa;
            --card: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 10px;
            background-color: var(--bg);
            color: #333;
        }

        h2 {
            margin: 15px 0 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin: 15px auto;
            max-width: 450px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .btn-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        @media (min-width: 480px) {
            .btn-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .relay-btn {
            width: 100%;
            min-height: 100px;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 10px 4px;
            overflow: hidden;
            position: relative;
        }

        .relay-btn:active {
            transform: scale(0.96);
        }

        .btn-on {
            background: var(--success);
        }

        .btn-off {
            background: var(--danger);
            opacity: 0.9;
        }

        .btn-label {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 8px;
            width: 100%;
            min-height: 2.4em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-badge {
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.25);
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        #connectionStatus {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 10px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        input,
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            box-sizing: border-box;
        }

        button.login {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .action-btn {
            background-color: var(--primary);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .sched-item {
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            text-align: left;
        }

        .chk-group {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .chk-label {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Tab Styles */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            max-width: 450px;
            margin: 0 auto 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #ddd;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            color: #555;
        }

        .tab-btn.active {
            background: var(--card);
            color: var(--primary);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        label.input-label {
            display: block;
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            margin: 10px 0 5px;
            text-align: left;
        }

        .full-width {
            width: 100%;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="card login-card" id="loginCard">
        <!-- AMK Logo Placeholder (SVG) -->
        <div style="margin-bottom:15px; display:flex; justify-content:center;">
            <div
                style="width:120px; height:120px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; border:3px solid #fff; box-shadow:0 3px 10px rgba(0,0,0,0.1); overflow:hidden;">
                <img src="logo.png" alt="Logo" style="width:100%; height:100%; object-fit: cover;">

            </div>
        </div>

        <h2 style="font-weight:800; color:#343a40; margin-bottom:0;">AMK Smart WiFi Switch</h2>
        <p style="color:#6c757d; margin-top:5px; font-size:0.9rem; margin-bottom:20px;">Control Panel</p>

        <div class="conn-status" id="connStatus" style="display:none">Connecting...</div>
        <input type="text" id="deviceIdInput" placeholder="e.g. 5CCF7F1A2B3D">
        <br>
        <input type="password" id="devicePinInput" placeholder="PIN (Default: 123456)" maxlength="6"
            style="margin-top:10px;">
        <br><br>
        <button class="login" onclick="connect()">Connect</button>
    </div>

    <div id="controlPanel" style="display:none">
        <div style="text-align:center; margin-top:10px;">
            <img src="logo.png" alt="Logo" style="width:120px; height:120px; border-radius:50%; margin-bottom:5px;">
            <h1 style="font-size:1.5rem; margin:10px 0 5px; color:#333;">Smart Cloud Control</h1>
            <div id="connectionStatus" class="disconnected">Disconnected</div>
        </div>

        <!-- Validity Banner -->
        <div id="expiryBanner"
            style="display:none; background:#dc3545; color:white; padding:15px; border-radius:12px; margin-bottom:15px; font-weight:bold; max-width: 450px; margin: 0 auto 15px auto;">
            ⚠️ CLOUD SERVICES EXPIRED ⚠️<br>
            <span style="font-size:0.8rem; font-weight:normal">Remote control features are disabled. Local Wi-Fi control
                remains active.</span>
        </div>

        <!-- Warning Banner -->
        <div id="warnBanner"
            style="display:none; background:#ffc107; color:#333; padding:15px; border-radius:12px; margin-bottom:15px; font-weight:bold; max-width: 450px; margin: 0 auto 15px auto;">
            ⚠️ SUBSCRIPTION ENDING SOON ⚠️<br>
            <span style="font-size:0.8rem; font-weight:normal" id="warnMsg">Renew soon.</span>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('home')">🏠 Home</button>
            <button class="tab-btn" onclick="showTab('settings')">⚙️ Settings</button>
        </div>

        <!-- HOME TAB -->
        <div id="tab-home" class="tab-content active">
            <div class="card" style="position:relative;">
                <button onclick="refreshState(this)"
                    style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; width:30px; height:30px; padding:0; line-height:1;"
                    title="Refresh Device Status">🔄</button>
                <h2>👋 Manual Control</h2>
                <div class="btn-container" id="relayContainer"></div>
            </div>

            <div class="card">
                <h2>⏱️ Multi-Timer</h2>
                <div id="timerList"></div>
            </div>

            <div class="card">
                <h2>📅 Schedules</h2>
                <div style="margin-bottom:10px;">
                    <label><input type="checkbox" id="schedMaster" onclick="toggleSchedGlobal()"> Global Schedule
                        Active</label>
                </div>
                <div id="scheduleList"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h2>ℹ️ System Info</h2>
                <div class="info-row"><span>Status:</span> <b id="infoStatus">Online</b></div>
                <div class="info-row"><span>Time:</span> <b id="infoTime">--:--</b></div>
                <div class="info-row"><span>IP Address:</span> <b id="infoIp">...</b></div>
                <div class="info-row"><span>WiFi Signal:</span> <b id="infoWifi">...</b></div>
                <div class="info-row"><span>License:</span> <b id="infoLic">...</b></div>
            </div>

            <div class="card">
                <h2>🏷️ Switch Labels</h2>
                <p style="font-size:0.8rem; color:#666; margin-top:-10px;">Rename your switches (e.g., Living Room)</p>
                <div id="labelInputs"></div>
                <button class="action-btn" onclick="saveContextLabels()">Save Labels</button>
            </div>

            <div class="card">
                <h2>🌍 Time & License</h2>
                <label class="input-label">Timezone (Offset Seconds)</label>
                <div style="display:flex; gap:5px;">
                    <select id="tzSelect" class="full-width" onchange="enableSaveTz()">
                        <!-- Populated by JS -->
                    </select>
                    <button class="action-btn" onclick="saveTz()" style="margin:0;">Set</button>
                </div>

                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

                <label class="input-label">Extend License (Paste Key)</label>
                <input type="text" id="licInput" class="full-width" placeholder="Paste license text here...">
                <button class="action-btn" onclick="submitLic()" id="btnLic" style="background:#28a745;">Activate
                    License</button>
            </div>
        </div>

    </div>

    <script>
        let client;
        // ... (existing vars) ...

        // ... (skipping unchanged parts until updateInfoUI) ...

        function updateInfoUI() {
            document.getElementById('infoStatus').innerText = "Connected";
            document.getElementById('infoTime').innerText = devInfo.time;
            document.getElementById('infoIp').innerText = devInfo.ip;
            let w = devInfo.wifi;
            let wText = "No WiFi";
            if (w) {
                if (w < 0) {
                    // RSSI Value (e.g. -65)
                    let qual = Math.min(Math.max(2 * (w + 100), 0), 100);
                    wText = `${qual}% (${w} dBm)`;
                } else {
                    wText = "Connected";
                }
            }
            document.getElementById('infoWifi').innerText = wText;

            let expText = devInfo.expired ? "EXPIRED" : (devInfo.daysLeft + " Days Left");
            let expCol = devInfo.expired ? "red" : "green";
            document.getElementById('infoLic').innerHTML = `<span style="color:${expCol}; font-weight:bold;">${expText}</span>`;

            // Logic for Banners
            if (devInfo.expired) {
                document.getElementById('expiryBanner').style.display = 'block';
                document.getElementById('warnBanner').style.display = 'none';
                setExpiryLock(true);
            } else if (devInfo.daysLeft <= 7 && devInfo.daysLeft >= 0) {
                document.getElementById('expiryBanner').style.display = 'none';
                document.getElementById('warnBanner').style.display = 'block';
                document.getElementById('warnMsg').innerText = devInfo.daysLeft + " days remaining.";
                setExpiryLock(false);
            } else {
                document.getElementById('expiryBanner').style.display = 'none';
                document.getElementById('warnBanner').style.display = 'none';
                setExpiryLock(false);
            }
        }

        function setExpiryLock(expired) {
            // Disable all interactive elements
            const els = document.querySelectorAll('button, input, select');
            els.forEach(el => {
                // EXEMPTIONS:
                // 1. Navigation Tabs (to switch between Home/Settings)
                if (el.classList.contains('tab-btn')) return;
                // 2. License Input
                if (el.id === 'licInput') return;
                // 3. License Submit Button
                if (el.id === 'btnLic') return;

                // Login screen inputs should not be locked by this status logic ideally because they are hidden,
                // but just in case:
                if (el.classList.contains('login') || el.id === 'deviceIdInput' || el.id === 'devicePinInput') return;

                el.disabled = expired;
                if (expired) {
                    el.style.opacity = "0.5";
                    el.style.cursor = "not-allowed";
                } else {
                    el.style.opacity = "1";
                    el.style.cursor = "pointer";
                    if (el.tagName === 'INPUT') el.style.cursor = "text";
                }
            });
        }

        let deviceId;
        const mqtt_broker = "210195b635414206adcd944325fe6f59.s1.eu.hivemq.cloud";
        const mqtt_port = 8884; // SSL Port
        const mqtt_user = "my_switch";
        const mqtt_pass = "My_password123";

        let timerPresets = [];
        let schedules = [];
        let globalSchedActive = true;
        let relayState = [];
        let timerRem = [];
        let relayLabels = [];
        let schedActive = [];
        let devInfo = { time: "", ip: "", wifi: 0, expired: 0, daysLeft: 0 };

        if (localStorage.getItem("lastDid")) document.getElementById('deviceIdInput').value = localStorage.getItem("lastDid");
        if (localStorage.getItem('lastPin') && document.getElementById('devicePinInput')) document.getElementById('devicePinInput').value = localStorage.getItem('lastPin');
        if (localStorage.getItem("lastPin") && document.getElementById('devicePinInput')) document.getElementById('devicePinInput').value = localStorage.getItem("lastPin");

        function initUI() {
            let rc = document.getElementById('relayContainer');
            let lc = document.getElementById('labelInputs');
            if (!rc) return; // robustness

            let htR = "";
            let htL = "";
            for (let i = 0; i < 8; i++) {
                htR += `<button id="btn${i}" class="relay-btn btn-off" onclick="toggle(${i})">`;
                htR += `<span class="btn-label" id="lbl${i}">S${i + 1}</span>`;
                htR += `<span class="status-badge">WAITING...</span>`;
                htR += `</button>`;

                htL += `<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <b style="width:30px;">S${i + 1}</b>
            <input type="text" id="inpLbl${i}" class="full-width" placeholder="Switch ${i + 1}" value="S${i + 1}">
         </div>`;
            }
            rc.innerHTML = htR;
            if (lc) lc.innerHTML = htL;

            initTimezones();
        }

        function initTimezones() {
            let sel = document.getElementById('tzSelect');
            if (!sel) return;
            sel.innerHTML = "";
            for (let i = -12; i <= 14; i += 0.5) {
                let val = i * 3600;
                let sign = i >= 0 ? "+" : "-";
                let h = Math.floor(Math.abs(i));
                let m = (Math.abs(i) % 1) * 60;
                let txt = `UTC ${sign}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                let opt = document.createElement("option");
                opt.value = val; opt.innerText = txt;
                sel.appendChild(opt);
            }
            sel.value = "19800"; // Default +5:30 (India) or 21600 (+6:00)
        }

        initUI();

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.className = 'tab-btn');
            document.getElementById('tab-' + t).style.display = 'block';
            event.target.className = 'tab-btn active';
        }

        let savedPin = "123456";
        function connect() {
            deviceId = document.getElementById('deviceIdInput').value.trim().toUpperCase();
            savedPin = document.getElementById('devicePinInput').value.trim();

            if (deviceId.length < 4) { alert("Please enter a valid Device ID"); return; }
            if (savedPin.length < 1) { alert('Please enter a Device PIN'); return; }

            localStorage.setItem("lastDid", deviceId);
            localStorage.setItem('lastPin', savedPin);

            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('connStatus').style.display = 'block';
            document.getElementById('connStatus').innerText = "Verifying Credentials...";
            let clientId = "CloudApp_" + new Date().getTime();

            client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, clientId);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: true, userName: mqtt_user, password: mqtt_pass });
        }

        function onConnect() {
            let s = document.getElementById('connectionStatus');
            s.innerText = "Connected to Cloud"; s.className = "connected";
            client.subscribe("smartswitch/" + deviceId + "/status");
            setTimeout(() => { sendCmd({ "get": 1 }); }, 500);
        }
        function onFail(e) {
            alert("Connection Failed. Check Settings.");
            document.getElementById('loginCard').style.display = 'block';
            document.getElementById('connStatus').style.display = 'none';
        }
        function onConnectionLost(r) {
            if (r.errorCode != 0) {
                console.log("Connection Lost");
            }
        }

        function onMessageArrived(message) {
            try {
                let data = JSON.parse(message.payloadString);

                if (data.error) {
                    alert("Security Error: " + data.error);
                    client.disconnect();
                    document.getElementById('loginCard').style.display = 'block';
                    document.getElementById('connStatus').style.display = 'none';
                    document.getElementById('controlPanel').style.display = 'none';
                    return;
                }

                if (data.states) {
                    // Verification Success: Show Control Panel
                    document.getElementById('controlPanel').style.display = 'block';
                    document.getElementById('connStatus').style.display = 'none';

                    relayState = data.states;
                    timerRem = data.rem || [];
                    relayLabels = data.lbl || relayLabels;
                    schedActive = data.sch || [];

                    // Updates Labels in Input fields if not focused? 
                    // Better to only update on Initial load or rely on user typing.
                    // We will just update the Labels on HOME tab.

                    devInfo.time = data.time || "--:--";
                    devInfo.ip = data.ip || "Unknown";
                    devInfo.wifi = data.wifi;
                    devInfo.expired = data.expired;
                    devInfo.daysLeft = data.daysLeft;

                    // Sync Timezone Selection
                    if (data.gmt) {
                        let sel = document.getElementById('tzSelect');
                        if (sel && sel.value != data.gmt) sel.value = data.gmt;
                    }

                    updateHomeUI();
                    // updateInfoUI(); // Moved to end
                }
                if (data.timers) { timerPresets = data.timers; renderTimers(); }
                if (data.schedules) { schedules = data.schedules; globalSchedActive = (data.sActive == 1); renderSchedules(); }

                // Always update Info/Lock UI LAST to ensure any re-rendered elements (like timers) get locked
                if (data.states || data.expired !== undefined) {
                    updateInfoUI();
                }

            } catch (e) { console.error(e); }
        }

        function updateHomeUI() {
            for (let i = 0; i < 8; i++) {
                let btn = document.getElementById('btn' + i);
                let on = relayState[i] == 1;
                btn.className = on ? "relay-btn btn-on" : "relay-btn btn-off";

                let lbl = relayLabels[i] ? relayLabels[i] : ("S" + (i + 1));
                document.getElementById('lbl' + i).innerText = lbl;

                // Also update Inputs if they are empty or first load
                let inp = document.getElementById('inpLbl' + i);
                if (inp && inp.value.startsWith("S") && lbl !== inp.value) inp.value = lbl;

                let badgeHTML = "";
                if (on) {
                    if (timerRem[i] > 0) {
                        let m = Math.ceil(timerRem[i] / 60);
                        badgeHTML = `⏳ TIMER ${m}m`;
                    } else if (schedActive[i] == 1) badgeHTML = `📅 SCHEDULE`;
                    else badgeHTML = `👋 MANUAL`;
                } else badgeHTML = `OFF`;

                btn.querySelector('.status-badge').innerHTML = badgeHTML;
            }
        }

        function updateInfoUI() {
            document.getElementById('infoStatus').innerText = "Connected";
            document.getElementById('infoTime').innerText = devInfo.time;
            document.getElementById('infoIp').innerText = devInfo.ip;
            let w = devInfo.wifi;
            let wText = "No WiFi";
            if (w) {
                if (w < 0) {
                    // RSSI Value (e.g. -65)
                    let qual = Math.min(Math.max(2 * (w + 100), 0), 100);
                    wText = `${qual}% (${w} dBm)`;
                } else {
                    wText = "Connected";
                }
            }
            document.getElementById('infoWifi').innerText = wText;

            let expText = devInfo.expired ? "EXPIRED" : (devInfo.daysLeft + " Days Left");
            let expCol = devInfo.expired ? "red" : "green";
            document.getElementById('infoLic').innerHTML = `<span style="color:${expCol}; font-weight:bold;">${expText}</span>`;

            // Logic for Banners
            if (devInfo.expired) {
                document.getElementById('expiryBanner').style.display = 'block';
                document.getElementById('warnBanner').style.display = 'none';
            } else if (devInfo.daysLeft <= 7 && devInfo.daysLeft >= 0) {
                document.getElementById('expiryBanner').style.display = 'none'; // FIX: Ensure expiry is hidden
                document.getElementById('warnBanner').style.display = 'block';
                document.getElementById('warnMsg').innerText = devInfo.daysLeft + " days remaining.";
            } else {
                document.getElementById('expiryBanner').style.display = 'none';
                document.getElementById('warnBanner').style.display = 'none';
            }
        }

        function sendCmd(payload) {
            if (!client || !client.isConnected()) return;
            // payload['pin'] = savedPin; // Duplicate line removed
            payload["pin"] = savedPin; // Secure PIN Injection
            let msg = new Paho.MQTT.Message(JSON.stringify(payload));
            msg.destinationName = "smartswitch/" + deviceId + "/set";
            client.send(msg);
        }

        function refreshState(btn) {
            if (devInfo.expired) { alert("License Expired."); return; }
            sendCmd({ "get": 1 });
            if (btn) {
                btn.innerHTML = "⏳";
                btn.style.opacity = "1";
                // Remove previous background styles
                btn.style.backgroundColor = "transparent";
                btn.style.boxShadow = "none";

                btn.disabled = true;
                setTimeout(() => {
                    btn.innerHTML = "🔄";
                    btn.disabled = false;
                }, 2000);
            }
        }

        function toggle(i) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            sendCmd({ "toggle": i });
        }

        // Settings Logic
        function saveContextLabels() {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            let payload = {};
            for (let i = 0; i < 8; i++) {
                payload[String(i)] = document.getElementById('inpLbl' + i).value.substring(0, 15); // Max 15 chars
            }
            sendCmd({ "savLbl": payload });
            alert("Labels Sent! Waiting for update...");
        }

        function saveTz() {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            let val = document.getElementById('tzSelect').value;
            sendCmd({ "tz": parseInt(val) });
            alert("Timezone Sent!");
        }

        function submitLic() {
            // ALWAYS ALLOWED
            let val = document.getElementById('licInput').value.trim();
            if (val.length < 5) return;
            sendCmd({ "lic": val });
            document.getElementById('licInput').value = "";
            alert("License Key Sent! Check Info status.");
        }

        function enableSaveTz() { /* visual effect? */ }

        function renderTimers() {
            let html = "";
            timerPresets.forEach((t, i) => {
                let isRunning = false;
                for (let r = 0; r < 8; r++) { if (((t.mask >> r) & 1) && timerRem[r] > 0) isRunning = true; }
                let actionBtn = "";
                if (isRunning) {
                    actionBtn = `<button class="action-btn" style="background:#fd7e14" onclick="stopTimer(${t.mask})">STOP</button>`;
                } else if (t.enabled) {
                    actionBtn = `<button class="action-btn" style="background:#17a2b8" onclick="runTimer(${t.min}, ${t.mask})">START</button>`;
                } else {
                    // Disabled state
                    actionBtn = `<button class="action-btn" style="background:#ccc; cursor:not-allowed; opacity:0.6" onclick="alert('Please enable this timer first.')">START</button>`;
                }

                html += `<div class="sched-item" style="opacity:${t.enabled ? 1 : 0.6}">
             <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                <div style="display:flex; align-items:center; gap:5px;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span>Run for</span>
                        <input type="number" value="${t.min}" onchange="saveTimer(${i}, this.value, ${t.mask}, ${t.enabled})" style="width:60px; padding:4px; border-radius:4px; border:1px solid #ccc; text-align:center;" min="1">
                        <span>mins</span>
                    </div>
                </div>
                <input type="checkbox" ${t.enabled ? 'checked' : ''} onchange="saveTimer(${i}, ${t.min}, ${t.mask}, this.checked)">
             </div>
             ${renderRelayMask(t.mask, (val) => saveTimer(i, t.min, val, t.enabled))}
             <div style="text-align:center; margin-top:5px;">${actionBtn}</div>
          </div>`;
            });
            document.getElementById('timerList').innerHTML = html || "<p style='color:#777'>No presets found.</p>";
        }

        function editTimerMin(i, oldMin) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            let newMin = prompt("Enter Timer Duration (minutes):", oldMin);
            if (newMin && !isNaN(newMin)) {
                let m = parseInt(newMin);
                if (m > 0 && m < 1440) {
                    let t = timerPresets[i];
                    saveTimer(i, m, t.mask, t.enabled);
                } else {
                    alert("Please enter valid minutes (1-1440)");
                }
            }
        }

        function runTimer(min, mask) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            sendCmd({ "timerReq": { "min": min, "mask": mask } });
        }
        function stopTimer(mask) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            sendCmd({ "stopTimer": { "mask": mask } });
        }
        function saveTimer(i, min, mask, en) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            sendCmd({ "timerSave": { "i": i, "min": min, "mask": mask, "en": en ? 1 : 0 } });
        }

        function renderSchedules() {
            document.getElementById('schedMaster').checked = globalSchedActive;
            let html = "";
            schedules.forEach((s, i) => {
                let sTime = pad(s.sH) + ":" + pad(s.sM);
                let eTime = pad(s.eH) + ":" + pad(s.eM);

                html += `<div class="sched-item" style="opacity:${s.on ? 1 : 0.6}">
             <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="display:flex; gap:5px; align-items:center;">
                     <input type="time" value="${sTime}" onchange="updateSchedTime(${i}, 's', this.value)" style="border:1px solid #ddd; border-radius:4px; padding:2px;">
                     <span>to</span>
                     <input type="time" value="${eTime}" onchange="updateSchedTime(${i}, 'e', this.value)" style="border:1px solid #ddd; border-radius:4px; padding:2px;">
                </div>
                <input type="checkbox" ${s.on ? 'checked' : ''} onchange="saveSched(${i}, ${s.sH},${s.sM},${s.eH},${s.eM},${s.m}, this.checked)">
             </div>
             ${renderRelayMask(s.m, (val) => saveSched(i, s.sH, s.sM, s.eH, s.eM, val, s.on))}
          </div>`;
            });
            document.getElementById('scheduleList').innerHTML = html || "<p style='color:#777'>No schedules.</p>";
        }

        function updateSchedTime(i, type, val) {
            let s = schedules[i];
            let parts = val.split(':');
            if (parts.length < 2) return;

            let h = parseInt(parts[0]);
            let m = parseInt(parts[1]);

            if (type === 's') { s.sH = h; s.sM = m; }
            else { s.eH = h; s.eM = m; }

            saveSched(i, s.sH, s.sM, s.eH, s.eM, s.m, s.on);
        }

        function toggleSchedGlobal() {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            sendCmd({ "schedGlobal": document.getElementById('schedMaster').checked ? 1 : 0 });
        }

        function saveSched(i, sH, sM, eH, eM, m, on) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            sendCmd({ "schedSave": { "i": i, "sH": sH, "sM": sM, "eH": eH, "eM": eM, "m": m, "on": on ? 1 : 0 } });
        }

        function pad(n) { return (n < 10 ? '0' : '') + n; }

        function editSched(i) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            let s = schedules[i];
            let newS = prompt("Start HH:MM", pad(s.sH) + ":" + pad(s.sM));
            if (!newS) return;
            let newE = prompt("End HH:MM", pad(s.eH) + ":" + pad(s.eM));
            if (!newE) return;

            let [sh, sm] = newS.split(':').map(Number);
            let [eh, em] = newE.split(':').map(Number);
            if (!isNaN(sh) && !isNaN(sm)) {
                saveSched(i, sh, sm, eh, em, s.m, s.on);
            }
        }

        // Interactive Checkbox Mask Renderer
        function renderRelayMask(mask, updateCallback) {
            // Generate unique ID for this group
            let id = "cb_" + Math.floor(Math.random() * 1000000);

            // Store the callback in global window scope so the inline onchange can find it
            window["cb_func_" + id] = updateCallback;

            let h = `<div class="chk-group" id="${id}">`;
            for (let r = 0; r < 8; r++) {
                let chk = ((mask >> r) & 1) ? "checked" : "";
                h += `<label class="chk-label">
                  <input type="checkbox" ${chk} onchange="handleMaskClick('${id}')"> S${r + 1}
               </label>`;
            }
            h += `</div>`;
            return h;
        }

        // Global handler to recalculate mask and call stored callback
        window.handleMaskClick = function (id) {
            let div = document.getElementById(id);
            if (!div) return;
            let newMask = 0;
            let inputs = div.querySelectorAll('input[type="checkbox"]');
            inputs.forEach((inp, idx) => {
                if (inp.checked) newMask |= (1 << idx);
            });

            // Call the specific callback function
            if (window["cb_func_" + id]) window["cb_func_" + id](newMask);
        };

        function pad(n) { return (n < 10 ? '0' : '') + n; }

        // --- DYNAMIC TIMER COUNTDOWN ---
        setInterval(() => {
            let needsUpdate = false;
            // Iterate over all 8 channels
            for (let i = 0; i < 8; i++) {
                if (timerRem[i] > 0) {
                    timerRem[i]--; // Decrement local counter
                    needsUpdate = true;
                    // If it hit 0 locally, we can optionally wait for server confirmation 
                    // or just show OFF. The UI logic handles 0 as OFF.
                }
            }
            if (needsUpdate) {
                updateHomeUI(); // Refresh badges (5m -> 4m etc)

                // Also refresh Timer Presets if Start/Stop buttons depend on status
                if (window.timerPresets) renderTimers();
            }
        }, 1000);
    </script>
</body>

</html>