<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Smart Switch Cloud</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3680/3680321.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f8f9fa;
            --card: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 10px;
            background-color: var(--bg);
            color: #333;
        }

        h2 {
            margin: 15px 0 10px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin: 15px auto;
            max-width: 450px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .btn-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .relay-btn {
            flex: 0 0 calc(50% - 5px);
            max-width: calc(50% - 5px);
            width: 100%;
            height: 135px !important;
            min-height: 135px !important;
            max-height: 135px !important;
            box-sizing: border-box;
            font-size: 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            padding: 10px 4px;
            overflow: hidden;
            position: relative;
        }

        @media (min-width: 480px) {
            .relay-btn {
                flex: 0 0 calc(25% - 8px);
                max-width: calc(25% - 8px);
            }
        }

        .relay-btn:active {
            transform: scale(0.96) translateY(4px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: none;
        }

        .btn-on {
            background: var(--success);
        }

        .btn-off {
            background: var(--danger);
            opacity: 0.9;
        }

        .btn-label {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.2;
            width: 100%;
            min-height: 2.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .status-badge {
            font-size: 0.75rem;
            font-weight: 500;
            background: rgba(0, 0, 0, 0.25);
            padding: 3px 10px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .timer-display {
            font-weight: bold;
            color: #ffc107;
            font-size: 0.9rem;
            margin-top: 5px;
            min-height: 1.2em;
        }

        #connectionStatus {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 10px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        input,
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            box-sizing: border-box;
        }

        /* Checkbox Alignment Match */
        .sched-master-label {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            color: #333;
        }

        .sched-master-label input[type="checkbox"] {
            width: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            height: 20px !important;
            flex-shrink: 0;
            accent-color: var(--primary);
            cursor: pointer;
        }

        button.login {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        .action-btn {
            background-color: var(--primary);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .action-btn:active {
            transform: scale(0.96) translateY(4px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: none;
        }

        .sched-item {
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            text-align: left;
        }

        .chk-group {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .chk-label {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            max-width: 450px;
            margin: 0 auto 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #ddd;
            cursor: pointer;
            font-weight: bold;
            border-radius: 12px;
            color: #555;
        }

        .tab-btn.active {
            background: var(--card);
            color: var(--primary);
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        label.input-label {
            display: block;
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            margin: 10px 0 5px;
            text-align: left;
        }

        .full-width {
            width: 100%;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
    </style>
</head>

<body ontouchstart="">

    <div class="card login-card" id="loginCard">
        <div style="margin-bottom:15px; display:flex; justify-content:center;">
            <div style="width:120px; height:120px; display:flex; align-items:center; justify-content:center;">
                <img src="logo.png" alt="Logo" style="width:100%; height:100%; object-fit: contain;">
            </div>
        </div>

        <h2 style="font-weight:800; color:#343a40; margin-bottom:0;">ESP32-Relay-Config</h2>
        <p style="color:#6c757d; margin-top:5px; font-size:0.9rem; margin-bottom:20px;">Control Panel</p>

        <div class="conn-status" id="connStatus" style="display:none">Connecting...</div>
        <input type="text" id="deviceIdInput" placeholder="e.g. 5CCF7F1A2B3D">
        <br>
        <input type="password" id="devicePinInput" placeholder="PIN (Default: 123456)" maxlength="6"
            style="margin-top:10px;">
        <br><br>
        <button class="login" onclick="connect()">Connect</button>
    </div>

    <div id="controlPanel" style="display:none">
        <div style="text-align:center; margin-top:10px;">
            <img src="logo.png" alt="Logo" style="width:120px; height:120px; margin-bottom:5px; object-fit: contain;">
            <h1 style="font-size:1.5rem; margin:10px 0 5px; color:#333;">Smart Cloud Control</h1>
            <div id="connectionStatus" class="disconnected">Disconnected</div>
        </div>

        <div id="deviceOfflineBanner"
            style="display:none; background:#343a40; color:white; padding:15px; border-radius:12px; margin-bottom:15px; font-weight:bold; max-width: 450px; margin: 0 auto 15px auto; border: 2px solid #dc3545;">
            📡 DEVICE OFFLINE 📡<br>
            <span style="font-size:0.8rem; font-weight:normal; color:#ddd;">Check Power or Wi-Fi Connection</span>
        </div>

        <div id="expiryBanner"
            style="display:none; background:#dc3545; color:white; padding:15px; border-radius:12px; margin-bottom:15px; font-weight:bold; max-width: 450px; margin: 0 auto 15px auto;">
            ⚠️ CLOUD SERVICES EXPIRED ⚠️<br>
            <span style="font-size:0.8rem; font-weight:normal">Remote control features are disabled. Local Wi-Fi control
                remains active.</span>
        </div>

        <div id="warnBanner"
            style="display:none; background:#ffc107; color:#333; padding:15px; border-radius:12px; margin-bottom:15px; font-weight:bold; max-width: 450px; margin: 0 auto 15px auto;">
            ⚠️ SUBSCRIPTION ENDING SOON ⚠️<br>
            <span style="font-size:0.8rem; font-weight:normal" id="warnMsg">Renew soon.</span>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="showTab('home')">🏠 Home</button>
            <button class="tab-btn" onclick="showTab('settings')">⚙️ Settings</button>
        </div>

        <!-- HOME TAB -->
        <div id="tab-home" class="tab-content active">
            <div class="card" style="position:relative;">
                <button id="refreshBtn" onclick="refreshState(this)"
                    style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; width:30px; height:30px; padding:0; line-height:1;"
                    title="Refresh Device Status">🔄</button>
                <h2>👋 Manual Control</h2>
                <div class="btn-container" id="relayContainer"></div>
            </div>

            <div class="card">
                <h2>⏱️ Multi-Timer</h2>
                <div style="margin: 10px 0; display:flex; justify-content:center; gap:15px; align-items:center;">
                    <button class="action-btn" style="width:auto; margin:0; padding:6px 12px; background:#28a745;"
                        onclick="addTimer()">+ Add Timer</button>
                </div>

                <div id="timerList"></div>
                <button class="action-btn" onclick="saveTimers()" style="width:100%">Save Timer Presets</button>
            </div>

            <div class="card">
                <h2>📅 Schedules</h2>
                <div style="margin: 10px 0; display:flex; justify-content:center; gap:15px; align-items:center;">
                    <button class="action-btn" style="width:auto; margin:0; padding:6px 12px; background:#28a745;"
                        onclick="addSched()">+ Add Schedule</button>
                </div>

                <div style="margin:10px 0;">
                    <label class="sched-master-label">
                        <input type="checkbox" id="schedMaster" onchange="saveAllSchedules(true);">
                        Global Schedule Active
                    </label>
                </div>
                <div id="scheduleList"></div>
                <button class="action-btn" onclick="saveAllSchedules()" style="width:100%">Save All Schedules</button>
                <div id="schedMsg"
                    style="margin-top:10px; font-weight:bold; color:#007bff; text-align:center; min-height:24px;"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="tab-content">
            <div class="card">
                <h2>ℹ️ System Info</h2>
                <div class="info-row"><span>Status:</span> <b id="infoStatus">Online</b></div>
                <div class="info-row"><span>Time:</span> <b id="infoTime">--:--</b></div>
                <div class="info-row"><span>IP Address:</span> <b id="infoIp">...</b></div>
                <div class="info-row"><span>WiFi Signal:</span> <b id="infoWifi">...</b></div>
                <div class="info-row"><span>License:</span> <b id="infoLic">...</b></div>
            </div>

            <div class="card">
                <h2>🏷️ Switch Labels</h2>
                <p style="font-size:0.8rem; color:#666; margin-top:-10px;">Rename your switches (e.g., Living Room)</p>
                <div id="labelInputs"></div>
                <button class="action-btn" onclick="saveContextLabels()">Save Labels</button>
            </div>

            <div class="card">
                <h2>🌍 System Config</h2>

                <label class="input-label">Active Channels</label>
                <div style="display:flex; gap:5px;">
                    <select id="chSet" class="full-width">
                        <option value="1">1 Channel</option>
                        <option value="2">2 Channels</option>
                        <option value="3">3 Channels</option>
                        <option value="4">4 Channels</option>
                        <option value="5">5 Channels</option>
                        <option value="6">6 Channels</option>
                        <option value="7">7 Channels</option>
                        <option value="8">8 Channels</option>
                    </select>
                    <button class="action-btn" onclick="saveCh()" style="margin:0;">Set</button>
                </div>

                <label class="input-label">Timezone (Offset Seconds)</label>

                <div style="display:flex; gap:5px;">
                    <select id="tzSelect" class="full-width" onchange="enableSaveTz()">
                        <!-- Populated by JS -->
                    </select>
                    <button class="action-btn" onclick="saveTz()" style="margin:0;">Set</button>
                </div>

                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

                <label class="input-label">Extend License (Paste Key)</label>
                <input type="text" id="licInput" class="full-width" placeholder="Paste license text here...">
                <button class="action-btn" onclick="submitLic()" id="btnLic" style="background:#28a745;">Activate
                    License</button>
            </div>
        </div>

    </div>

    <script>
        let client;
        let deviceId;
        const mqtt_broker = "210195b635414206adcd944325fe6f59.s1.eu.hivemq.cloud";
        const mqtt_port = 8884;
        const mqtt_user = "my_switch";
        const mqtt_pass = "My_password123";

        let timerPresets = [];
        let schedules = [];
        let globalSchedActive = true;
        let relayState = [];
        let timerRem = [];
        let relayLabels = [];
        let schedActive = [];
        let maxCh = 8;
        let devInfo = { time: "", ip: "", wifi: 0, expired: 0, daysLeft: 0 };


        if (localStorage.getItem("lastDid")) document.getElementById('deviceIdInput').value = localStorage.getItem("lastDid");
        if (localStorage.getItem('lastPin') && document.getElementById('devicePinInput')) document.getElementById('devicePinInput').value = localStorage.getItem('lastPin');

        function initUI() {
            let rc = document.getElementById('relayContainer');
            let lc = document.getElementById('labelInputs');
            if (!rc) return;

            let htR = "";
            let htL = "";
            for (let i = 0; i < maxCh; i++) {
                htR += `<button id="btn${i}" class="relay-btn btn-off" onclick="toggle(${i})">`;
                htR += `<span class="btn-label" id="lbl${i}">S${i + 1}</span>`;
                htR += `<span class="status-badge">WAITING...</span>`;
                htR += `<div id="td${i}" class="timer-display"></div>`;
                htR += `</button>`;

                htL += `<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <b style="width:30px;">S${i + 1}</b>
            <input type="text" id="inpLbl${i}" class="full-width" placeholder="Switch ${i + 1}" value="S${i + 1}">
         </div>`;
            }
            rc.innerHTML = htR;
            if (lc) lc.innerHTML = htL;

            initTimezones();
        }

        function initTimezones() {
            let sel = document.getElementById('tzSelect');
            if (!sel) return;
            sel.innerHTML = "";
            for (let i = -12; i <= 14; i += 0.5) {
                let val = i * 3600;
                let sign = i >= 0 ? "+" : "-";
                let h = Math.floor(Math.abs(i));
                let m = (Math.abs(i) % 1) * 60;
                let txt = `UTC ${sign}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                let opt = document.createElement("option");
                opt.value = val; opt.innerText = txt;
                sel.appendChild(opt);
            }
            sel.value = "23400";
        }

        initUI();

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.className = 'tab-btn');
            document.getElementById('tab-' + t).style.display = 'block';
            event.target.className = 'tab-btn active';
        }

        let savedPin = "123456";
        function connect() {
            deviceId = document.getElementById('deviceIdInput').value.trim().toUpperCase();
            savedPin = document.getElementById('devicePinInput').value.trim();

            if (deviceId.length < 4) { alert("Please enter a valid Device ID"); return; }
            if (savedPin.length < 1) { alert('Please enter a Device PIN'); return; }

            localStorage.setItem("lastDid", deviceId);
            localStorage.setItem('lastPin', savedPin);

            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('connStatus').style.display = 'block';
            document.getElementById('connStatus').innerText = "Verifying Credentials...";
            let clientId = "CloudApp_" + new Date().getTime();

            client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, clientId);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: true, userName: mqtt_user, password: mqtt_pass });
        }

        function onConnect() {
            let s = document.getElementById('connectionStatus');
            s.innerText = "☁️ App Connected";
            s.className = "connected";
            s.style.color = "#28a745";
            client.subscribe("smartswitch/" + deviceId + "/status");
            setTimeout(() => { sendCmd({ "get": 1 }); }, 500);
        }
        function onFail(e) {
            console.log("Connection Failed: " + e.errorMessage);
            if (document.getElementById('controlPanel').style.display === 'block') {
                let s = document.getElementById('connectionStatus');
                if (s) s.innerText = "Retrying...";
                setTimeout(() => {
                    client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: true, userName: mqtt_user, password: mqtt_pass });
                }, 5000);
            } else {
                alert("Connection Failed. Check Settings.");
                document.getElementById('loginCard').style.display = 'block';
                document.getElementById('connStatus').style.display = 'none';
            }
        }
        function onConnectionLost(r) {
            if (r.errorCode != 0) {
                console.log("Connection Lost: " + r.errorMessage);
                let s = document.getElementById('connectionStatus');
                if (s) {
                    s.innerText = "Reconnecting...";
                    s.className = "disconnected";
                    s.style.color = "#fd7e14";
                }
                setTimeout(() => {
                    if (!client.isConnected()) {
                        client.connect({ onSuccess: onConnect, onFailure: onFail, useSSL: true, userName: mqtt_user, password: mqtt_pass });
                    }
                }, 3000);
            }
        }

        function onMessageArrived(message) {
            if (window.updateLock) return;
            try {
                let data = JSON.parse(message.payloadString);

                if (data.online === false) {
                    showDeviceOffline();
                    return;
                }

                if (data.error) {
                    alert("Security Error: " + data.error);
                    client.disconnect();
                    document.getElementById('loginCard').style.display = 'block';
                    document.getElementById('connStatus').style.display = 'none';
                    document.getElementById('controlPanel').style.display = 'none';
                    return;
                }

                if (data.states || data.online === true) {
                    showDeviceOnline();
                    document.getElementById('controlPanel').style.display = 'block';
                    document.getElementById('connStatus').style.display = 'none';

                    if (data.states) {
                        if (!window.ignoreUpdates) window.ignoreUpdates = [];
                        for (let i = 0; i < 8; i++) {
                            if (!window.ignoreUpdates[i] || Date.now() > window.ignoreUpdates[i]) {
                                relayState[i] = data.states[i];
                            }
                        }
                        timerRem = data.rem || [];
                        relayLabels = data.lbl || relayLabels;
                        schedActive = data.sch || [];

                        devInfo.time = data.time || "--:--";
                        devInfo.ip = data.ip || "Unknown";
                        devInfo.wifi = data.wifi;
                        devInfo.expired = data.expired;
                        devInfo.daysLeft = data.daysLeft;

                        if (data.gmt) {
                            let sel = document.getElementById('tzSelect');
                            if (sel && sel.value != data.gmt) sel.value = data.gmt;
                        }

                        if (data.ch && data.ch != maxCh) {
                            maxCh = data.ch;
                            initUI(); // Re-render
                            updateHomeUI();
                        }
                        if (data.ch) {
                            let s = document.getElementById('chSet');
                            if (s) s.value = data.ch;
                        }

                        updateHomeUI();
                    }

                }
                if (data.timers) {
                    timerPresets = data.timers.filter(t => t.min > 0 || t.mask > 0 || t.enabled);
                    renderTimers();
                }
                if (data.schedules) {
                    // Filter out invalid schedules (0-duration or invalid time)
                    schedules = data.schedules.filter(s => {
                        let isZeroDuration = (s.sH === s.eH && s.sM === s.eM);
                        let isInvalidTime = (s.sH > 23 || s.sM > 59 || s.eH > 23 || s.eM > 59);
                        let isEmpty = (s.on === 0 && s.m === 0);
                        return (s.on || s.m > 0) && !(isZeroDuration || isInvalidTime || isEmpty);
                    });
                    if (data.sActive !== undefined) globalSchedActive = (data.sActive == 1);
                    renderSchedules();
                }

                if (data.states || data.expired !== undefined) {
                    updateInfoUI();
                }

            } catch (e) { console.error(e); }
        }

        function showDeviceOffline() {
            document.getElementById('deviceOfflineBanner').style.display = 'block';
            let all = document.querySelectorAll('button, input');
            all.forEach(el => {
                if (el.id !== 'refreshBtn') {
                    el.disabled = true;
                    el.style.opacity = "0.5";
                    el.style.cursor = "not-allowed";
                }
            });
        }

        function showDeviceOnline() {
            document.getElementById('deviceOfflineBanner').style.display = 'none';
            let all = document.querySelectorAll('button, input');
            all.forEach(el => {
                el.disabled = false;
                el.style.opacity = "1";
                el.style.cursor = "pointer";
            });
        }

        function updateHomeUI() {
            if (document.getElementById('deviceOfflineBanner').style.display === 'block') return;

            for (let i = 0; i < maxCh; i++) {
                let btn = document.getElementById('btn' + i);

                if (btn) {
                    let on = relayState[i] == 1;
                    let isSched = schedActive[i] == 1;
                    let timerRunning = timerRem[i] > 0;

                    btn.className = on ? "relay-btn btn-on" : "relay-btn btn-off";
                    let badgeText = "OFF";
                    let isReady = (devInfo.ready === 1) || (devInfo.ready === undefined && devInfo.time != "--:--");

                    if (!isReady) {
                        badgeText = "📡<br>CHECKING...";
                        btn.style.opacity = "0.9";
                    } else {
                        btn.style.opacity = "1";
                        if (on) {
                            if (timerRunning) badgeText = "⏳<br>TIMER";
                            else if (isSched) badgeText = "📅<br>SCHEDULE";
                            else badgeText = "👋<br>MANUAL";
                        }
                    }

                    btn.querySelector('.status-badge').innerHTML = badgeText;

                    let tdEl = document.getElementById('td' + i);
                    if (tdEl) {
                        if (timerRunning) {
                            let t = timerRem[i];
                            tdEl.innerText = Math.ceil(t / 60) + "m";
                        } else {
                            tdEl.innerText = "";
                        }
                    }

                    if (relayLabels && relayLabels[i]) {
                        document.getElementById('lbl' + i).innerText = relayLabels[i];
                        let inp = document.getElementById('inpLbl' + i);
                        if (inp && document.activeElement !== inp) inp.value = relayLabels[i];
                    }
                }
            }
        }

        function updateInfoUI() {
            document.getElementById('infoStatus').innerText = "Connected";
            document.getElementById('infoTime').innerText = devInfo.time;
            document.getElementById('infoIp').innerText = devInfo.ip;
            let w = devInfo.wifi;
            let wText = "No WiFi";
            if (w) {
                if (w < 0) {
                    let qual = Math.min(Math.max(2 * (w + 100), 0), 100);
                    wText = `${qual}% (${w} dBm)`;
                } else {
                    wText = "Connected";
                }
            }
            document.getElementById('infoWifi').innerText = wText;

            let expText = devInfo.expired ? "EXPIRED" : (devInfo.daysLeft + " Days Left");
            let expCol = devInfo.expired ? "red" : "green";
            document.getElementById('infoLic').innerHTML = `<span style="color:${expCol}; font-weight:bold;">${expText}</span>`;

            if (devInfo.expired) {
                document.getElementById('expiryBanner').style.display = 'block';
                document.getElementById('warnBanner').style.display = 'none';
                setExpiryLock(true);
            } else if (devInfo.daysLeft <= 7 && devInfo.daysLeft >= 0) {
                document.getElementById('expiryBanner').style.display = 'none';
                document.getElementById('warnBanner').style.display = 'block';
                document.getElementById('warnMsg').innerText = devInfo.daysLeft + " days remaining.";
                setExpiryLock(false);
            } else {
                document.getElementById('expiryBanner').style.display = 'none';
                document.getElementById('warnBanner').style.display = 'none';
                setExpiryLock(false);
            }
        }

        function setExpiryLock(expired) {
            const els = document.querySelectorAll('button, input, select');
            els.forEach(el => {
                if (el.classList.contains('tab-btn')) return;
                if (el.id === 'licInput') return;
                if (el.id === 'btnLic') return;
                if (el.classList.contains('login') || el.id === 'deviceIdInput' || el.id === 'devicePinInput') return;

                el.disabled = expired;
                if (expired) {
                    el.style.opacity = "0.5";
                    el.style.cursor = "not-allowed";
                } else {
                    el.style.opacity = "1";
                    el.style.cursor = "pointer";
                    if (el.tagName === 'INPUT') el.style.cursor = "text";
                }
            });
        }

        function sendCmd(payload) {
            if (!client || !client.isConnected()) return;
            payload["pin"] = savedPin;
            let msg = new Paho.MQTT.Message(JSON.stringify(payload));
            msg.destinationName = "smartswitch/" + deviceId + "/set";
            client.send(msg);
        }

        function refreshState(btn) {
            if (devInfo.expired) { alert("License Expired."); return; }
            sendCmd({ "get": 1 });
            if (btn) {
                btn.innerHTML = "⏳";
                btn.style.opacity = "1";
                btn.style.backgroundColor = "transparent";
                btn.style.boxShadow = "none";

                btn.style.pointerEvents = "none";
                setTimeout(() => {
                    btn.innerHTML = "🔄";
                    btn.style.pointerEvents = "auto";
                }, 2000);
            }
        }

        function toggle(i) {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            relayState[i] = !relayState[i] ? 1 : 0;
            updateHomeUI();
            if (!window.ignoreUpdates) window.ignoreUpdates = [];
            window.ignoreUpdates[i] = Date.now() + 2000;
            sendCmd({ "toggle": i });
        }

        function saveContextLabels() {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            let payload = {};
            for (let i = 0; i < 8; i++) {
                payload[String(i)] = document.getElementById('inpLbl' + i).value.substring(0, 15);
            }
            sendCmd({ "savLbl": payload });
            alert("Labels Sent! Waiting for update...");
        }

        function saveTz() {
            if (devInfo.expired) { alert("License Expired. Remote control disabled."); return; }
            let val = document.getElementById('tzSelect').value;
            sendCmd({ "tz": parseInt(val) });
            alert("Timezone Sent!");
        }

        function saveCh() {
            let val = document.getElementById('chSet').value;
            sendCmd({ "ch": parseInt(val) });
            alert("Channel Setting Sent! Device will update shortly.");
        }

        function submitLic() {
            let val = document.getElementById('licInput').value.trim();
            if (val.length < 5) return;
            sendCmd({ "lic": val });
            document.getElementById('licInput').value = "";
            alert("License Key Sent! Check Info status.");
        }

        function enableSaveTz() { }

        // --- UNIFIED TIMER LOGIC ---
        function renderTimers() {
            let html = "";
            if (timerPresets.length === 0) html = "<div style='color:#777; font-style:italic; text-align:center;'>No timer presets. Click '+ Add Timer'.</div>";

            timerPresets.forEach((t, i) => {
                if (i >= maxCh) return; // Hide disabled channels
                let disabledState = t.enabled ? "" : "disabled='true'";
                let opacity = t.enabled ? "1" : "0.7";

                let btnLabel = "▶ START";
                let btnBg = t.enabled ? "#17a2b8" : "#6c757d";
                let btnAction = `runTimer(${i})`;

                let isRunning = false;
                for (let r = 0; r < 8; r++) { if (((t.mask >> r) & 1) && timerRem[r] > 0) isRunning = true; }

                if (isRunning) {
                    btnLabel = "⬛ STOP";
                    btnBg = "#fd7e14";
                    btnAction = `stopTimer(${i})`;
                }

                html += `<div class="sched-item" style="opacity:${opacity}">
             <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
                <div style="font-weight:bold; color:#007bff; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" ${t.enabled ? 'checked' : ''} onchange="updT(${i},'en',this.checked)" style="width:18px; height:18px;">
                    Preset ${i + 1}
                </div>
                <button onclick="remTimer(${i})" style="background:#dc3545; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer;">✕</button>
             </div>
             <div style="display:flex; gap:10px; justify-content:center; margin-bottom:8px; align-items:center;">
                <span>Run for</span>
                <input type="number" value="${t.min}" onchange="updT(${i},'min',this.value)" style="width:60px; padding:4px; border-radius:4px; border:1px solid #ccc; text-align:center;" min="1">
                <span>mins</span>
             </div>
             ${renderRelayMask('timer', i, t.mask)}
             <div style="text-align:center; margin-top:5px;">
                <button class="action-btn" style="background:${btnBg}; width:100%;" onclick="${btnAction}" ${disabledState}>${btnLabel}</button>
             </div>
          </div>`;
            });
            document.getElementById('timerList').innerHTML = html;
        }

        function addTimer() {
            if (timerPresets.length >= maxCh) { alert("Max " + maxCh + " presets allowed!"); return; }

            timerPresets.push({ min: 10, mask: 0, enabled: 1 });
            renderTimers();
        }

        function remTimer(i) {
            if (confirm("Delete this preset?")) {
                timerPresets.splice(i, 1);
                renderTimers();
                saveTimers(true);
            }
        }

        function updT(i, type, val) {
            if (type === 'min') timerPresets[i].min = parseInt(val);
            else if (type === 'en') timerPresets[i].enabled = val ? 1 : 0;
            else if (type === 'mask') timerPresets[i].mask = val;
            renderTimers();
        }

        window.updateLock = false;

        function sendBatchCmd(list, successMsg, silent) {
            if (!list || list.length === 0) return;
            updateLock = true;
            let index = 0;
            function next() {
                if (index < list.length) {
                    sendCmd(list[index]);
                    index++;
                    setTimeout(next, 400);
                } else {
                    if (!silent && successMsg) alert(successMsg);
                    setTimeout(() => { updateLock = false; console.log("Unlock"); }, 2500);
                }
            }
            next();
        }

        function saveTimers(silent) {
            if (devInfo.expired) { alert("License Expired."); return; }
            let payloads = [];
            for (let i = 0; i < 6; i++) {
                if (i < timerPresets.length) {
                    let t = timerPresets[i];
                    if (t.enabled && t.mask === 0 && !silent) { alert("Preset " + (i + 1) + " has no switches selected!"); return; }
                    payloads.push({ "timerSave": { "i": i, "min": t.min, "mask": t.mask, "en": t.enabled } });
                } else {
                    payloads.push({ "timerSave": { "i": i, "min": 0, "mask": 0, "en": 0 } });
                }
            }
            sendBatchCmd(payloads, "Timers Saved!", silent);
        }

        function runTimer(i) {
            if (devInfo.expired) { alert("License Expired."); return; }
            let t = timerPresets[i];
            if (!t.mask) { alert("Select switches first!"); return; }

            if (!window.ignoreUpdates) window.ignoreUpdates = [];
            for (let r = 0; r < 8; r++) {
                if (((t.mask >> r) & 1)) {
                    relayState[r] = 1;
                    timerRem[r] = t.min * 60;
                    window.ignoreUpdates[r] = Date.now() + 2500;
                }
            }
            updateHomeUI();
            renderTimers();

            let payloads = [];
            payloads.push({ "timerSave": { "i": i, "min": t.min, "mask": t.mask, "en": t.enabled } });

            updateLock = true;
            sendCmd(payloads[0]);
            setTimeout(() => {
                sendCmd({ "timerReq": { "min": t.min, "mask": t.mask } });
                setTimeout(() => { updateLock = false; }, 2000);
            }, 500);
        }

        function stopTimer(i) {
            let t = timerPresets[i];
            if (!window.ignoreUpdates) window.ignoreUpdates = [];
            for (let r = 0; r < 8; r++) {
                if (((t.mask >> r) & 1)) {
                    relayState[r] = 0;
                    timerRem[r] = 0;
                    window.ignoreUpdates[r] = Date.now() + 2500;
                }
            }
            updateHomeUI();
            renderTimers();
            sendCmd({ "stopTimer": { "mask": t.mask } });
        }


        // --- UNIFIED SCHEDULE LOGIC ---
        function renderSchedules() {
            // Checkbox sync
            document.getElementById('schedMaster').checked = globalSchedActive;

            // --- FIXED: ADDED VISIBILITY FILTER TO MESSAGE LOGIC ---
            let msg = document.getElementById('schedMsg');
            if (msg) {
                if (!globalSchedActive) {
                    msg.innerText = "Global Schedule Disabled";
                    msg.style.color = "#007bff";
                } else {
                    // Create a mask to only check currently VISIBLE channels (e.g. 4ch = 00001111)
                    let visibleChannelsMask = (1 << maxCh) - 1;

                    let count = 0;
                    let activeTotalMask = 0;

                    schedules.forEach(s => {
                        // A schedule is counted if it's ON and triggers at least one VISIBLE channel
                        if (s.on && s.m !== 0) {
                            let effectiveMask = s.m & visibleChannelsMask;
                            if (effectiveMask > 0) {
                                count++;
                                activeTotalMask |= effectiveMask;
                            }
                        }
                    });

                    let activeSwitches = [];
                    // Only iterate up to maxCh to list switches
                    for (let i = 0; i < maxCh; i++) {
                        if ((activeTotalMask >> i) & 1) {
                            let lbl = (relayLabels && relayLabels[i]) ? relayLabels[i] : ("S" + (i + 1));
                            activeSwitches.push(lbl);
                        }
                    }

                    if (count > 0) {
                        msg.innerText = count + " Active Schedule(s) (Switches: " + activeSwitches.join(", ") + ")";
                    } else {
                        msg.innerText = "0 Active Schedule(s)";
                    }
                    msg.style.color = "#007bff";
                }
            }
            // --------------------------------------------------

            let html = "";
            if (schedules.length === 0) html = "<div style='color:#777; font-style:italic; text-align:center;'>No schedules set. Click '+ Add Schedule'.</div>";

            schedules.forEach((s, i) => {
                if (i >= maxCh) return; // Hide disabled channels
                let sTime = pad(s.sH) + ":" + pad(s.sM);
                let eTime = pad(s.eH) + ":" + pad(s.eM);
                let opacity = s.on ? "1" : "0.7";

                html += `<div class="sched-item" style="opacity:${opacity}">
             <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
                <div style="font-weight:bold; color:#007bff; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" ${s.on ? 'checked' : ''} onchange="updS(${i},'on',this.checked)" style="width:18px; height:18px;">
                    Schedule ${i + 1}
                </div>
                <button onclick="remSched(${i})" style="background:#dc3545; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer;">✕</button>
             </div>
             <div style="display:flex; gap:10px; justify-content:center; margin-bottom:8px;">
                <input type="time" value="${sTime}" onchange="updS(${i}, 's', this.value)" style="border:1px solid #ddd; border-radius:4px; padding:4px;">
                <span style="align-self:center">to</span>
                <input type="time" value="${eTime}" onchange="updS(${i}, 'e', this.value)" style="border:1px solid #ddd; border-radius:4px; padding:4px;">
             </div>
             ${renderRelayMask('sched', i, s.m)}
          </div>`;
            });
            document.getElementById('scheduleList').innerHTML = html;
        }

        function addSched() {
            if (schedules.length >= maxCh) { alert("Max " + maxCh + " schedules allowed!"); return; }

            schedules.push({ sH: 18, sM: 0, eH: 22, eM: 0, m: 0, on: 1 });
            renderSchedules();
        }

        function remSched(i) {
            if (confirm("Delete this schedule?")) {
                schedules.splice(i, 1);
                renderSchedules();
                saveAllSchedules(true);
            }
        }

        function updS(i, type, val) {
            if (type === 'on') schedules[i].on = val ? 1 : 0;
            else if (type === 'mask') schedules[i].m = val;
            else if (type === 's' || type === 'e') {
                let parts = val.split(':');
                if (parts.length < 2) return;
                let h = parseInt(parts[0]);
                let m = parseInt(parts[1]);
                if (type === 's') { schedules[i].sH = h; schedules[i].sM = m; }
                else { schedules[i].eH = h; schedules[i].eM = m; }
            }
            renderSchedules();
        }

        function saveAllSchedules(silent) {
            if (devInfo.expired) { alert("License Expired."); return; }

            // FIXED: Using "schedGlobal" key to match ESP32 code
            let master = document.getElementById('schedMaster').checked;
            globalSchedActive = master; // Optimistic update

            // FIXED: RE-RENDER TO UPDATE MESSAGE INSTANTLY
            renderSchedules();

            let payloads = [];
            payloads.push({ "schedGlobal": master ? 1 : 0 });

            for (let i = 0; i < maxCh; i++) {
                if (i < schedules.length) {
                    let s = schedules[i];
                    // Only validate if Global Schedule is ACTIVE
                    if (master && s.on && s.m === 0 && !silent) { alert("Schedule #" + (i + 1) + " has no switches selected!"); return; }
                    payloads.push({ "schedSave": { "i": i, "sH": s.sH, "sM": s.sM, "eH": s.eH, "eM": s.eM, "m": s.m, "on": s.on ? 1 : 0 } });
                } else {
                    payloads.push({ "schedDel": i });
                }
            }
            sendBatchCmd(payloads, "Schedules Saved!", silent);
        }

        function pad(n) { return (n < 10 ? '0' : '') + n; }

        function renderRelayMask(context, index, currentMask) {
            let html = `<div class="chk-group" style="justify-content:center; gap:10px; margin-bottom:10px; display:flex; flex-wrap:wrap;">`;
            for (let r = 0; r < maxCh; r++) {

                let checked = ((currentMask >> r) & 1) ? "checked" : "";
                let lbl = relayLabels[r] ? relayLabels[r] : ("S" + (r + 1));

                html += `<label style="display:flex; align-items:center; gap:6px; font-size:0.95rem; font-weight:bold; cursor:pointer;">
                    <input type="checkbox" ${checked} onchange="handleMaskClick('${context}', ${index}, ${r}, this.checked)"> 
                    ${lbl}
                </label>`;
            }
            html += `</div>`;
            return html;
        }

        function handleMaskClick(ctx, idx, bit, val) {
            if (ctx === 'timer') {
                let t = timerPresets[idx];
                if (val) t.mask |= (1 << bit);
                else t.mask &= ~(1 << bit);
                renderTimers();
            } else {
                let s = schedules[idx];
                if (val) s.m |= (1 << bit);
                else s.m &= ~(1 << bit);
                renderSchedules();
            }
        }

        function saveCh() {
            let val = document.getElementById('chSet').value;
            sendCmd({ "ch": parseInt(val) });
            alert("Channel Setting Sent! Device will update shortly.");
        }


        setInterval(() => {
            let needsUpdate = false;
            for (let i = 0; i < maxCh; i++) {

                if (timerRem[i] > 0) {
                    timerRem[i]--;
                    needsUpdate = true;
                }
            }
            if (needsUpdate) {
                updateHomeUI();
                if (window.timerPresets) renderTimers();
            }
        }, 1000);
    </script>
</body>

</html>